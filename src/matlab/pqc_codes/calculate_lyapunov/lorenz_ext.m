function f=lorenz_ext(t,X)
%
%  Lorenz equation 
%
%               dx/dt = SIGMA*(y - x)
%               dy/dt = R*x - y -x*z
%               dz/dt= x*y - BETA*z
%
%        In demo run SIGMA = 10, R = 28, BETA = 8/3
%        Initial conditions: x(0) = 0, y(0) = 1, z(0) = 0;
%        Reference values for t=10 000 : 
%              L_1 = 0.9022, L_2 = 0.0003, LE3 = -14.5691
%
%        See:
%    K. Ramasubramanian, M.S. Sriram, "A comparative study of computation 
%    of Lyapunov spectra with different algorithms", Physica D 139 (2000) 72-86.
%
% --------------------------------------------------------------------
% Copyright (C) 2004, Govorukhin V.N.
% Values of parameters
% SIGMA = 10;
% R = 28;
% BETA = 8/3;
% x=X(1); y=X(2); z=X(3);
% Y= [X(4), X(7), X(10);
%     X(5), X(8), X(11);
%     X(6), X(9), X(12)];
% f=zeros(9,1);
% %Lorenz equation
% f(1)=SIGMA*(y-x);
% f(2)=-x*z+R*x-y;
% f(3)=x*y-BETA*z;
% %Linearized system
%  Jac=[-SIGMA, SIGMA,     0;
%          R-z,    -1,    -x;
%            y,     x, -BETA];
%   
% %Variational equation   
% f(4:12)=Jac*Y;
% %Output data must be a column vector



%%%%%%%%%Modified Differential Eqns%%%%%%%%%
%%%%%%%%% Key %%%%%%%%%%
m1=0.2944;m2=0.1756;m3=0.0947;
L1=0.508;L2=0.254;L3=0.127;
k1=0.005;k2=0;k3=0.0008;
I1=9.526e-3;I2=1.625e-3;I3=1.848e-4;
g=9.81;

syms x1 x2 x3 x4 x5 x6

x = zeros(6,1);
x(1)=X(1);x(2)=X(2); x(3)=X(3);x(4)=X(4);x(5)=X(5); x(6)=X(6);
f=zeros(42,1);

f(1) = x(4);
f(2) = x(5);
f(3) = x(6);
f(4) = 0-(2*(((L3^2)*(m3^2)*sin(2*x(1)-2*x(3))*(4*I2-(L2^2)*m2)+(L2^2)*sin(2*x(1)-2*x(2))*(m2 + 2*m3)*(m2*m3*(L3^2)+4*I3*(m2 + 2*m3)))*(L1^2)*(x(4)^2) +(L2*(sin(x(1)- x(2))*((m2*m3*(m2 + 3*m3)*(L3^2)+ 4*I3*((m2^2)+ 6*m2*m3 + 8*(m3^2)))*(L2^2)+4*I2*(m3*(m2 +m3)*(L3^2) + 4*I3*(m2 + 2*m3)))+(L3^2)*(m3^2)*sin(x(1) + x(2) -2*x(3))*(4*I2-(L2^2)*m2))*(x(5)^2)- 4*k2*L2*(cos(x(1)-x(2))*(m3*(m2 +m3)*(L3^2)+4*I3*(m2+2*m3))- (L3^2)*(m3^2)*cos(x(1)+x(2)-2*x(3)))*(x(5)^2)+ L3*m3*(sin(x(1)-x(3))*(8*I3*m3*(L2^2)+4*I2*m3*(L3^2)+16*I2*I3)+ (L2^2)*sin(x(1)-2*x(2) +x(3))*(m2*m3*(L3^2) +4*I3*(m2 +2*m3)))*(x(6)^2)- 4*k3*L3*m3*(cos(x(1)-x(3))*(2*m3*(L2^2) +4*I2)- (L2^2)*cos(x(1)-2*x(2) + x(3))*(m2 + 2*m3))*x(6)- g*(sin(x(1))*((m3*(m1*m2 + 2*m1*m3 + 3*m2*m3 + (m2^2))*(L3^2) + 4*I3*((m2^2)+ 6*m2*m3 + m1*m2 + 4*(m3^2)+ 4*m1*m3))*(L2^2)+ 4*I2*(m3*(m1 + 2*m2 + m3)*(L3^2) + 4*I3*(m1 + 2*m2 + 2*m3)))+ (L3^2)*(m3^2)*(sin(x(1)-2*x(3))*(4*I2-(L2^2)*m2)- 2*(L2^2)*cos(2*x(2)-2*x(3))*sin(x(1))*(m1 + m2))+ (L2^2)*sin(x(1)-2*x(2))*(m2 + 2*m3)*(m2*m3*(L3^2) +4*I3*(m2+2*m3))))*L1+ 2*k1*(4*I2*(m3*(L3^2) + 4*I3)+(L2^2)*(m3*(m2+2*m3)*(L3^2) + 4*I3*(m2+4*m3))-2*(L2^2)*(L3^2)*(m3^2)*cos(2*x(2)-2*x(3)))*x(1)))/(64*I1*I2*I3 +8*I3*(L1^2)*(L2^2)*(m2^2)+8*I1*(L2^2)*(L3^2)*(m3^2)+8*I2*(L1^2)*(L3^2)*(m3^2)+32*I3*(L1^2)*(L2^2)*(m3^2)+ 16*I2*I3*(L1^2)*m1 +16*I1*I3*(L2^2)*m2 +64*I2*I3*(L1^2)*m2+16*I1*I2*(L3^2)*m3+ 64*I1*I3*(L2^2)*m3 +64*I2*I3*(L1^2)*m3+4*I3*(L1^2)*(L2^2)*m1*m2+4*I2*(L1^2)*(L3^2)*m1*m3+ 16*I3*(L1^2)*(L2^2)*m1*m3+4*I1*(L2^2)*(L3^2)*m2*m3 +16*I2*(L1^2)*(L3^2)*m2*m3 +48*I3*(L1^2)*(L2^2)*m2*m3- 8*I1*(L2^2)*(L3^2)*(m3^2)*cos(2*x(2)-2*x(3))- 2*(L1^2)*(L2^2)*cos(2*x(1)-2*x(2))*(m2 +2*m3)*(m2*m3*(L3^2)+4*I3*(m2+2*m3))- 2*(L1^2)*(L3^2)*(m3^2)*cos(2*x(1)-2*x(3))*(-m2*(L2^2)+4*I2)+2*(L1^2)*(L2^2)*(L3^2)*m1*(m3^2) + 6*(L1^2)*(L2^2)*(L3^2)*m2*(m3^2) + 2*(L1^2)*(L2^2)*(L3^2)*(m2^2)*m3+ (L1^2)*(L2^2)*(L3^2)*m1*m2*m3 - 2*(L1^2)*(L2^2)*(L3^2)*m1*(m3^2)*cos(2*x(2)-2*x(3))- 4*(L1^2)*(L2^2)*(L3^2)*m2*(m3^2)*cos(2*x(2)-2*x(3)));
f(5) = (2*(((L1^2)*sin(2*x(1) - 2*x(2))*(m2 + 2*m3)*(m2*m3*(L3^2) + 4*I3*(m2 + 2*m3))- (L3^2)*(m3^2)*sin(2*x(2) - 2*x(3))*((m1 +2*m2)*(L1^2) +4*I1))*(L2^2)*(x(5)^2) + L1*(sin(x(1) -x(2))*((m3*(m1*(m2 +m3)+2*m2*(2*m2 +3*m3))*(L3^2)+4*I3*(m2 +2*m3)*(m1 +4*m2 + 4*m3))*(L1^2) + 4*I1*(m3*(m2 + m3)*(L3^2) + 4*I3*(m2 + 2*m3)))-(L3^2)*(m3^2)*sin(x(1) + x(2) - 2*x(3))*((m1 + 2*m2)*(L1^2) + 4*I1))*L2*(x(4)^2)+4*k1*L1*(cos(x(1) - x(2))*(m3*(m2 + m3)*(L3^2) + 4*I3*(m2 + 2*m3))-(L3^2)*(m3^2)*cos(x(1) + x(2) - 2*x(3)))*L2*x(4) +(-L3*m3*(sin(x(2)-x(3))*((m3*(m1+3*m2)*(L3^2)+ 4*I3*(m1+3*m2+2*m3))*(L1^2)+4*I1*(m3*(L3^2)+4*I3))-(L1^2)*sin(2*x(1)-x(2)-x(3))*(m2*m3*(L3^2) +4*I3*(m2 +2*m3)))*(x(6)^2)+ 4*k3*L3*m3*(cos(x(2) -x(3))*((m1 +3*m2 +2*m3)*(L1^2) +4*I1)- (L1^2)*cos(2*x(1) -x(2)-x(3))*(m2+2*m3))*x(6)+ g*(sin(x(2))*((m2*m3*(2*m2+3*m3)*(L3^2)+ 8*I3*((m2^2)+3*m2*m3+2*(m3^2)))*(L1^2) + 4*I1*(m3*(m2+m3)*(L3^2) +4*I3*(m2 + 2*m3)))- (L1^2)*sin(2*x(1) - x(2))*(m3*(m1*(m2 + m3) + m2*(2*m2 + 3*m3))*(L3^2)+ 4*I3*(m2 +2*m3)*(m1 + 2*m2 + 2*m3)) + (L3^2)*(m3^2)*(sin(x(2) - 2*x(3))*(m2*(L1^2) + 4*I1)+ (L1^2)*sin(2*x(1) + x(2) - 2*x(3))*(m1 +m2))))*L2- 2*k2*(4*I1*(m3*(L3^2) + 4*I3) + (L1^2)*(m3*(m1 + 4*m2 + 2*m3)*(L3^2)+ 4*I3*(m1 + 4*m2 + 4*m3)) - 2*(L1^2)*(L3^2)*(m3^2)*cos(2*x(1) -2*x(3)))*(x(5)^2)))/(64*I1*I2*I3 +8*I3*(L1^2)*(L2^2)*(m2^2)+8*I1*(L2^2)*(L3^2)*(m3^2)+8*I2*(L1^2)*(L3^2)*(m3^2)+32*I3*(L1^2)*(L2^2)*(m3^2)+16*I2*I3*(L1^2)*m1 + 16*I1*I3*(L2^2)*m2 +64*I2*I3*(L1^2)*m2+ 16*I1*I2*(L3^2)*m3+64*I1*I3*(L2^2)*m3+64*I2*I3*(L1^2)*m3+4*I3*(L1^2)*(L2^2)*m1*m2+ 4*I2*(L1^2)*(L3^2)*m1*m3+16*I3*(L1^2)*(L2^2)*m1*m3+4*I1*(L2^2)*(L3^2)*m2*m3+ 16*I2*(L1^2)*(L3^2)*m2*m3 +48*I3*(L1^2)*(L2^2)*m2*m3 -8*I1*(L2^2)*(L3^2)*(m3^2)*cos(2*x(2) -2*x(3))- 2*(L1^2)*(L2^2)*cos(2*x(1) -2*x(2))*(m2 +2*m3)*(m2*m3*(L3^2)+4*I3*(m2+2*m3))- 2*(L1^2)*(L3^2)*(m3^2)*cos(2*x(1)-2*x(3))*(-m2*(L2^2)+4*I2)+2*(L1^2)*(L2^2)*(L3^2)*m1*(m3^2)+ 6*(L1^2)*(L2^2)*(L3^2)*m2*(m3^2)+2*(L1^2)*(L2^2)*(L3^2)*(m2^2)*m3 + (L1^2)*(L2^2)*(L3^2)*m1*m2*m3- 2*(L1^2)*(L2^2)*(L3^2)*m1*(m3^2)*cos(2*x(2) - 2*x(3)) - 4*(L1^2)*(L2^2)*(L3^2)*m2*(m3^2)*cos(2*x(2) - 2*x(3)));
f(6) = 0-(2*(32*I1*I2*k3*x(6) - L2*L3*m3*(x(5)^2)*(sin(x(2) - x(3))*(((L2^2)*(m1*m2 + 4*m1*m3 + 6*m2*m3 + (m2^2))+ 4*I2*(m1 +3*m2 + 2*m3))*(L1^2) + 4*I1*(4*I2 + (L2^2)*(m2 + 4*m3)))+ (L1^2)*sin(2*x(1) - x(2) - x(3))*(m2 + 2*m3)*(4*I2 - m2*(L2^2)))- L1*L3*m3*(x(4)^2)*(sin(x(1) -x(3))*(8*I1*(m3*(L2^2) +2*I2)+2*(L1^2)*((m1*m3 -(m2^2))*(L2^2)+ 2*I2*(m1 +4*m2 +4*m3)))- (L2^2)*sin(x(1) -2*x(2) + x(3))*(m2 + 2*m3)*((m1 + 2*m2)*(L1^2) + 4*I1))+ 4*k3*(L1^2)*(L2^2)*(m2^2)*x(6) + 16*k3*(L1^2)*(L2^2)*(m3^2)*x(6) + 8*I2*k3*(L1^2)*m1*x(6)+ 8*I1*k3*(L2^2)*m2*x(6) + 32*I2*k3*(L1^2)*m2*x(6) + 32*I1*k3*(L2^2)*m3*x(6)+ 32*I2*k3*(L1^2)*m3*x(6) - 4*k1*L1*L3*m3*x(4)*(cos(x(1) - x(3))*(2*m3*(L2^2) +4*I2)- (L2^2)*cos(x(1) - 2*x(2) + x(3))*(m2 + 2*m3)) - 16*I1*I2*g*L3*m3*sin(x(3))- 4*I2*(L1^2)*(L3^2)*(m3^2)*(x(6)^2)*sin(2*x(1) - 2*x(3)) -4*I1*(L2^2)*(L3^2)*(m3^2)*(x(6)^2)*sin(2*x(2) -2*x(3))+ 8*I2*g*(L1^2)*L3*(m3^2)*sin(2*x(1) -x(3))+8*I1*g*(L2^2)*L3*(m3^2)*sin(2*x(2) -x(3))+ 2*k3*(L1^2)*(L2^2)*m1*m2*x(6) + 8*k3*(L1^2)*(L2^2)*m1*m3*x(6) + 24*k3*(L1^2)*(L2^2)*m2*m3*x(6)- 4*k2*L2*L3*m3*x(5)*(cos(x(2) - x(3))*((m1 + 3*m2 + 2*m3)*(L1^2) + 4*I1)- (L1^2)*cos(2*x(1) - x(2) - x(3))*(m2 + 2*m3)) - 8*I1*g*(L2^2)*L3*(m3^2)*sin(x(3))- 8*I2*g*(L1^2)*L3*(m3^2)*sin(x(3)) - 4*k3*(L1^2)*(L2^2)*(m2^2)*x(6)*cos(2*x(1) -2*x(2))- 16*k3*(L1^2)*(L2^2)*(m3^2)*x(6)*cos(2*x(1) - 2*x(2)) - 8*I2*g*(L1^2)*L3*m2*m3*sin(x(3))- 16*k3*(L1^2)*(L2^2)*m2*m3*x(6)*cos(2*x(1) - 2*x(2)) -(L1^2)*(L2^2)*(L3^2)*m1*(m3^2)*(x(6)^2)*sin(2*x(2) - 2*x(3))+ (L1^2)*(L2^2)*(L3^2)*m2*(m3^2)*(x(6)^2)*sin(2*x(1) - 2*x(3)) - 2*(L1^2)*(L2^2)*(L3^2)*m2*(m3^2)*(x(6)^2)*sin(2*x(2) -2*x(3))+ 2*g*(L1^2)*(L2^2)*L3*m1*(m3^2)*sin(2*x(1) - x(3)) - g*(L1^2)*(L2^2)*L3*(m2^2)*m3*sin(2*x(1) - x(3))+ 2*g*(L1^2)*(L2^2)*L3*m2*(m3^2)*sin(2*x(2) -x(3)) + g*(L1^2)*(L2^2)*L3*(m2^2)*m3*sin(2*x(2) - x(3))+ 4*I2*g*(L1^2)*L3*m1*m3*sin(2*x(1) - x(3)) + 8*I2*g*(L1^2)*L3*m2*m3*sin(2*x(1) - x(3))+ 4*I1*g*(L2^2)*L3*m2*m3*sin(2*x(2) - x(3)) - 2*g*(L1^2)*(L2^2)*L3*m1*(m3^2)*sin(2*x(1) - 2*x(2) + x(3))- 2*g*(L1^2)*(L2^2)*L3*m2*(m3^2)*sin(2*x(1) - 2*x(2) +x(3)) - g*(L1^2)*(L2^2)*L3*(m2^2)*m3*sin(2*x(1) - 2*x(2) + x(3))+ g*(L1^2)*(L2^2)*L3*(m2^2)*m3*sin(x(3)) - g*(L1^2)*(L2^2)*L3*m1*m2*m3*sin(2*x(1) - 2*x(2) +x(3))))/(64*I1*I2*I3 + 8*I3*(L1^2)*(L2^2)*(m2^2)+ 8*I1*(L2^2)*(L3^2)*(m3^2)*+ 8*I2*(L1^2)*(L3^2)*(m3^2)+ 32*I3*(L1^2)*(L2^2)*(m3^2)+ 16*I2*I3*(L1^2)*m1 + 16*I1*I3*(L2^2)*m2 +64*I2*I3*(L1^2)*m2+ 16*I1*I2*(L3^2)*m3+64*I1*I3*(L2^2)*m3+64*I2*I3*(L1^2)*m3+4*I3*(L1^2)*(L2^2)*m1*m2+ 4*I2*(L1^2)*(L3^2)*m1*m3+16*I3*(L1^2)*(L2^2)*m1*m3+4*I1*(L2^2)*(L3^2)*m2*m3+ 16*I2*(L1^2)*(L3^2)*m2*m3 +48*I3*(L1^2)*(L2^2)*m2*m3 -8*I1*(L2^2)*(L3^2)*(m3^2)*cos(2*x(2) -2*x(3))- 2*(L1^2)*(L2^2)*cos(2*x(1) -2*x(2))*(m2 +2*m3)*(m2*m3*(L3^2) +4*I3*(m2+2*m3))- 2*(L1^2)*(L3^2)*(m3^2)*cos(2*x(1)-2*x(3))*(4*I2-m2*(L2^2))+2*(L1^2)*(L2^2)*(L3^2)*m1*(m3^2)+ 6*(L1^2)*(L2^2)*(L3^2)*m2*(m3^2) + 2*(L1^2)*(L2^2)*(L3^2)*(m2^2)*m3 + (L1^2)*(L2^2)*(L3^2)*m1*m2*m3- 2*(L1^2)*(L2^2)*(L3^2)*m1*(m3^2)*cos(2*x(2) - 2*x(3)) - 4*(L1^2)*(L2^2)*(L3^2)*m2*(m3^2)*cos(2*x(2) - 2*x(3)));
Jac = calc_jacobian();
Jac = subs(Jac,[x1,x2,x3,x4,x5,x6],[X(1),X(2),X(3),X(4),X(5),X(6)]);
Y= [X(7), X(13), X(19), X(25), X(31), X(37);
    X(8), X(14), X(20), X(26), X(32), X(38);
    X(9), X(15), X(21), X(27), X(33), X(39);
    X(10), X(16), X(22), X(28), X(34), X(40);
    X(11), X(17), X(23), X(29), X(35), X(41);
    X(12), X(18), X(24), X(30), X(36), X(42)];
f(7:42)=Jac*Y;